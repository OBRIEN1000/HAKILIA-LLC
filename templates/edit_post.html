{% extends "base.html" %}
{% block title %}Modifier l’article - {{ post.title }}{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% endblock %}

{% block content %}
<header class="bg-purple-600 text-white p-6 rounded-lg shadow-lg mb-6">
    <h1 class="text-3xl font-bold">Modifier l’article</h1>
    <a href="{{ url_for('dashboard') }}" class="inline-block mt-4 bg-white text-purple-600 px-4 py-2 rounded hover:bg-gray-100">← Retour</a>
</header>

<div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md max-w-2xl mx-auto">
    <form action="{{ url_for('edit_post', post_id=post.id) }}" method="POST" enctype="multipart/form-data" class="space-y-6" id="edit-form">
        {{ form.csrf_token }}

        <!-- Titre -->
        <div>
            {{ form.title.label(class="block text-sm font-semibold mb-1") }}
            {{ form.title(class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600") }}
        </div>

        <!-- Éditeur Quill -->
        <div>
            <label for="editor" class="block text-sm font-semibold mb-1">Contenu</label>
            <div id="editor" class="bg-white dark:bg-gray-700 h-64 rounded border dark:border-gray-600 p-2 overflow-y-auto">
                {{ form.content.data|safe or '' }}
            </div>
            <input type="hidden" name="content" id="content">
        </div>

        <!-- Catégorie -->
        <div>
            {{ form.category.label(class="block text-sm font-semibold mb-1") }}
            {{ form.category(class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600") }}
        </div>

        <!-- Média -->
        <div>
            {{ form.media.label(class="block text-sm font-semibold mb-1") }}
            {{ form.media(class="w-full p-2 border rounded") }}
            {% if post.media_path %}
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Fichier actuel :</p>
                {% if post.media_path.endswith('mp4') %}
                    <video controls class="w-full max-h-56 mt-2 rounded">
                        <source src="{{ url_for('static', filename='uploads/' + post.media_path) }}" type="video/mp4">
                    </video>
                {% else %}
                    <img src="{{ url_for('static', filename='uploads/' + post.media_path) }}" alt="media" class="mt-2 rounded max-h-56">
                {% endif %}
            {% endif %}
        </div>

        <!-- Publié -->
        <div>
            {{ form.published.label(class="inline-block mr-2 text-sm font-medium") }}
            {{ form.published() }}
        </div>

        <!-- Bouton -->
        <button type="submit" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 transition">
            {{ form.submit.label.text or 'Mettre à jour' }}
        </button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Modifie ici le contenu...',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'header': 1 }, { 'header': 2 }],
                    [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'image'],
                    ['clean']
                ]
            }
        });

        const form = document.querySelector('#edit-form');
        const contentInput = document.querySelector('#content');

        if (form && contentInput) {
            form.addEventListener('submit', () => {
                const html = quill.root.innerHTML;
                console.log('Contenu modifié :', html);
                contentInput.value = html;
            });
        } else {
            console.warn("Formulaire ou champ #content introuvable !");
        }
    });
</script>
{% endblock %}